<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Rift: Aether Wars (Multiplayer)</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        :root {
            --primary-glow: #00ffff; --secondary-glow: #ff00ff; --background-color: #0c001f;
            --text-color: #f0f8ff; --card-bg: #1a0537; --border-color: #4a00e0;
            --danger-color: #ff4141; --menu-width: 320px;
        }
        body {
            font-family: 'Orbitron', sans-serif; background-color: var(--background-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden;
            background-image: radial-gradient(circle, #1a0537, #0c001f 80%);
        }
        .screen { display: none; width: 100%; height: 100%; justify-content: center; align-items: center; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .screen.active { display: flex; }
        .container { text-align: center; padding: 40px; border: 2px solid var(--primary-glow); box-shadow: 0 0 25px var(--primary-glow); border-radius: 15px; background: rgba(0,0,0,0.6); }
        .title { font-size: 3.5em; color: var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow), 0 0 20px var(--secondary-glow); margin-bottom: 40px; }
        .button { display: block; width: 280px; padding: 15px 20px; margin: 15px auto; font-family: 'Orbitron', sans-serif; font-size: 1.2em; background-color: transparent; color: var(--primary-glow); border: 2px solid var(--primary-glow); border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .button:hover { background-color: var(--primary-glow); color: var(--background-color); box-shadow: 0 0 20px var(--primary-glow); }
        .gamemode-description { font-size: 0.9em; color: var(--text-color); opacity: 0.8; max-width: 300px; margin: -10px auto 20px auto; }
        .input-field { background-color: #1a0537; border: 2px solid var(--border-color); color: var(--text-color); padding: 10px; font-family: 'Orbitron', sans-serif; border-radius: 5px; width: 280px; text-align: center; font-size: 1.2em; margin-bottom: 15px; }
        .game-id-display { font-size: 1.5em; color: var(--secondary-glow); margin: 20px 0; user-select: all; }
        #game-container { width: 100%; height: 100%; max-width: 1400px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 15px; box-sizing: border-box; border: 2px solid var(--primary-glow); box-shadow: 0 0 25px var(--primary-glow); border-radius: 15px; background: rgba(0,0,0,0.4); }
        .player-area { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .player-info, .opponent-info { flex-basis: 25%; text-align: center; }
        .player-info h2, .opponent-info h2 { margin: 0; text-shadow: 0 0 5px var(--text-color); }
        .score { font-size: 4em; font-weight: 700; text-shadow: 0 0 15px var(--primary-glow); line-height: 1.1; }
        .status-effects { font-size: 0.8em; color: var(--secondary-glow); height: 18px; margin-top: 5px; }
        .dark-matter-active { filter: blur(5px); }
        .center-area { text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #game-title { font-size: 2em; font-weight: 700; color: var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow), 0 0 20px var(--secondary-glow); margin: 0 0 10px 0; }
        #message-area { height: 30px; font-size: 1.2em; color: var(--secondary-glow); text-shadow: 0 0 5px var(--secondary-glow); transition: all 0.3s; }
        .deck-area { display: flex; gap: 20px; margin-top: 20px; }
        .card-pile { width: 100px; height: 150px; border: 2px dashed var(--border-color); border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .card-pile.disabled { cursor: not-allowed; opacity: 0.6; }
        .card-pile:not(.disabled):hover { border-color: var(--primary-glow); box-shadow: 0 0 15px var(--primary-glow); }
        .card-pile::before { content: 'DECK'; position: absolute; top: 5px; font-size: 0.8em; }
        #deck-count { font-size: 2em; }
        .player-hand { width: 100%; height: 170px; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
        .card { width: 100px; height: 150px; background-color: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 10px; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.5); transition: all 0.3s ease; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 0 15px var(--secondary-glow); border-color: var(--secondary-glow); }
        .card.disabled { cursor: not-allowed; opacity: 0.6; }
        .card.disabled:hover { transform: none; box-shadow: 0 0 10px rgba(0,0,0,0.5); border-color: var(--border-color); }
        .card-name { font-size: 1em; font-weight: 700; text-align: center; }
        .card-type { font-size: 0.7em; font-style: italic; color: var(--primary-glow); }
        .card-effect { font-size: 0.8em; text-align: center; }
        .card.aether-shard { border-color: #00ffff; } .card.attack { border-color: #ff4141; } .card.defense { border-color: #3dff3d; } .card.special { border-color: #ff00ff; }
        .game-controls, .game-over-buttons { display: none; margin-top: 15px; }
        .game-controls.active, .game-over-buttons.active { display: block; }
        .game-control-btn, .game-over-button { padding: 10px 20px; font-family: 'Orbitron', sans-serif; font-size: 1em; background-color: transparent; color: var(--primary-glow); border: 2px solid var(--primary-glow); border-radius: 5px; cursor: pointer; transition: all 0.3s; margin: 0 10px; }
        .game-control-btn:hover, .game-over-button:hover { background-color: var(--primary-glow); color: var(--background-color); box-shadow: 0 0 15px var(--primary-glow); }
        .game-control-btn:disabled { cursor: not-allowed; opacity: 0.5; background-color: transparent !important; color: var(--primary-glow) !important; box-shadow: none !important; }
        #quit-game-btn { color: var(--danger-color); border-color: var(--danger-color); }
        #quit-game-btn:hover { background-color: var(--danger-color); color: var(--background-color); box-shadow: 0 0 15px var(--danger-color); }
    </style>
</head>
<body>

    <!-- Main Menu -->
    <div id="menu-screen" class="screen active">
        <div class="container">
            <h1 class="title">Cosmic Rift</h1>
            <button id="single-player-btn" class="button">Single Player (vs AI)</button>
            <button id="multiplayer-btn" class="button">Multiplayer</button>
        </div>
    </div>

    <!-- Multiplayer Menu -->
    <div id="multiplayer-screen" class="screen">
        <div class="container">
            <h2 class="title">Multiplayer</h2>
            <button id="host-game-btn" class="button">Host Game</button>
            <button id="join-game-btn" class="button">Join Game</button>
            <button class="button back-to-main">Back</button>
        </div>
    </div>
    
    <!-- Host Game Screen -->
    <div id="host-screen" class="screen">
        <div class="container">
            <h2 class="title">Select Mode</h2>
            <button class="button gamemode-button" data-mode="classic">Classic</button>
            <p class="gamemode-description">Hand Size: 3. A balanced set of core cards.</p>
            <button class="button gamemode-button" data-mode="duelist">Duelist's Edge</button>
            <p class="gamemode-description">Hand Size: 2. A tactical mode with no chaotic cards.</p>
            <button class="button gamemode-button" data-mode="gambit">Cosmic Gambit</button>
            <p class="gamemode-description">Hand Size: 4. A mode focused on hand management.</p>
            <button class="button gamemode-button" data-mode="chaos">Cosmic Chaos</button>
            <p class="gamemode-description">Hand Size: Unlimited. All cards are in the deck.</p>
            <button class="button back-to-multiplayer">Back</button>
        </div>
    </div>

    <!-- Join Game Screen -->
    <div id="join-screen" class="screen">
        <div class="container">
            <h2 class="title">Join Game</h2>
            <input type="text" id="game-id-input" class="input-field" placeholder="Enter Game ID">
            <button id="submit-join-btn" class="button">Join</button>
            <button class="button back-to-multiplayer">Back</button>
        </div>
    </div>

    <!-- Waiting Screen -->
    <div id="waiting-screen" class="screen">
        <div class="container">
            <h2 class="title">Waiting for Opponent...</h2>
            <p>Share this Game ID with a friend:</p>
            <div id="game-id-display" class="game-id-display"></div>
            <p>The game will start automatically when they join.</p>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div id="game-container">
            <div class="player-area">
                <div class="player-info">
                    <h2 id="player-name">Player</h2>
                    <div id="player-score" class="score">0</div>
                    <div id="player-status" class="status-effects"></div>
                </div>
                <div class="center-area">
                    <h1 id="game-title">Aether Wars</h1>
                    <div id="message-area"></div>
                    <div class="deck-area">
                        <div id="deck" class="card-pile"><span id="deck-count"></span></div>
                    </div>
                    <div id="game-controls" class="game-controls active">
                        <button id="end-turn-btn" class="game-control-btn">End Turn</button>
                        <button id="quit-game-btn" class="game-control-btn">Quit</button>
                    </div>
                    <div id="game-over-buttons" class="game-over-buttons">
                        <button id="main-menu-btn" class="game-over-button">Main Menu</button>
                    </div>
                </div>
                <div class="opponent-info">
                    <h2 id="opponent-name">Opponent</h2>
                    <div id="opponent-score" class="score">0</div>
                    <div id="opponent-status" class="status-effects"></div>
                </div>
            </div>
            <div class="player-hand" id="player-hand"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- SOCKET.IO ---
    // Establish connection with the server.
    // IMPORTANT: When you host this online, you might need to change this
    // to your server's URL, e.g., const socket = io('https://your-game-url.com');
    const socket = io();

    // --- DOM ELEMENTS ---
    const screens = {
        menu: document.getElementById('menu-screen'),
        multiplayer: document.getElementById('multiplayer-screen'),
        host: document.getElementById('host-screen'),
        join: document.getElementById('join-screen'),
        waiting: document.getElementById('waiting-screen'),
        game: document.getElementById('game-screen'),
    };
    const singlePlayerBtn = document.getElementById('single-player-btn');
    const multiplayerBtn = document.getElementById('multiplayer-btn');
    const hostGameBtn = document.getElementById('host-game-btn');
    const joinGameBtn = document.getElementById('join-game-btn');
    const gamemodeButtons = document.querySelectorAll('.gamemode-button');
    const gameIdInput = document.getElementById('game-id-input');
    const submitJoinBtn = document.getElementById('submit-join-btn');
    const gameIdDisplay = document.getElementById('game-id-display');
    const backToMainBtns = document.querySelectorAll('.back-to-main');
    const backToMultiplayerBtns = document.querySelectorAll('.back-to-multiplayer');

    const gameContainer = document.getElementById('game-container');
    const playerNameEl = document.getElementById('player-name');
    const opponentNameEl = document.getElementById('opponent-name');
    const playerScoreEl = document.getElementById('player-score');
    const opponentScoreEl = document.getElementById('opponent-score');
    const playerStatusEl = document.getElementById('player-status');
    const opponentStatusEl = document.getElementById('opponent-status');
    const messageArea = document.getElementById('message-area');
    const deckEl = document.getElementById('deck');
    const deckCountEl = document.getElementById('deck-count');
    const playerHandEl = document.getElementById('player-hand');
    const gameControls = document.getElementById('game-controls');
    const endTurnBtn = document.getElementById('end-turn-btn');
    const quitGameBtn = document.getElementById('quit-game-btn');
    const gameOverButtons = document.getElementById('game-over-buttons');
    const mainMenuBtn = document.getElementById('main-menu-btn');

    // --- CLIENT-SIDE GAME STATE ---
    let myPlayerNum = null;
    let currentRoomId = null;

    // --- SCREEN MANAGEMENT ---
    function showScreen(screenName) {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[screenName].classList.add('active');
    }

    // --- UI EVENT LISTENERS ---
    singlePlayerBtn.addEventListener('click', () => alert('Single player mode is coming soon!'));
    multiplayerBtn.addEventListener('click', () => showScreen('multiplayer'));
    hostGameBtn.addEventListener('click', () => showScreen('host'));
    joinGameBtn.addEventListener('click', () => showScreen('join'));
    backToMainBtns.forEach(btn => btn.addEventListener('click', () => showScreen('menu')));
    backToMultiplayerBtns.forEach(btn => btn.addEventListener('click', () => showScreen('multiplayer')));
    
    gamemodeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            socket.emit('hostGame', { gameMode: mode });
        });
    });

    submitJoinBtn.addEventListener('click', () => {
        const roomId = gameIdInput.value.trim();
        if (roomId) {
            socket.emit('joinGame', { roomId: roomId });
        }
    });

    // --- GAME ACTION EMITTERS ---
    deckEl.addEventListener('click', () => {
        // Client no longer checks for turn validity, server will do it.
        socket.emit('playerAction', { action: 'drawCard' });
    });

    endTurnBtn.addEventListener('click', () => {
        socket.emit('playerAction', { action: 'endTurn' });
    });
    
    quitGameBtn.addEventListener('click', () => {
        socket.emit('playerAction', { action: 'quit' });
        returnToMenu();
    });

    mainMenuBtn.addEventListener('click', returnToMenu);

    function playActionCard(card, index) {
        socket.emit('playerAction', { action: 'playCard', cardIndex: index });
    }

    function returnToMenu() {
        showScreen('menu');
        // Reset local state
        myPlayerNum = null;
        currentRoomId = null;
    }

    // --- SOCKET.IO EVENT HANDLERS ---
    socket.on('gameCreated', (data) => {
        currentRoomId = data.roomId;
        gameIdDisplay.textContent = data.roomId;
        showScreen('waiting');
    });

    socket.on('gameUpdate', (data) => {
        const { gameState, message, activePlayer, gameIsOver } = data;
        
        // Determine who is who
        const me = gameState.players[socket.id];
        myPlayerNum = me.playerNum;
        const opponent = Object.values(gameState.players).find(p => p.socketId !== socket.id);

        // Update UI based on received game state
        updateUI(gameState, message, activePlayer, gameIsOver, opponent);
    });
    
    socket.on('gameStart', (data) => {
        showScreen('game');
        const { gameState, message, activePlayer, gameIsOver } = data;
        const opponent = Object.values(gameState.players).find(p => p.socketId !== socket.id);
        updateUI(gameState, message, activePlayer, gameIsOver, opponent);
    });

    socket.on('playerLeft', (data) => {
        showMessage(data.message);
        endTurnBtn.disabled = true;
        deckEl.classList.add('disabled');
        playerHandEl.querySelectorAll('.card').forEach(c => c.classList.add('disabled'));
        gameOverButtons.classList.add('active');
        gameControls.classList.remove('active');
    });

    socket.on('error', (data) => {
        alert(`Error: ${data.message}`);
        showScreen('multiplayer');
    });

    // --- MASTER UI UPDATE FUNCTION ---
    function updateUI(gameState, message, activePlayer, gameIsOver, opponent) {
        const me = gameState.players[socket.id];
        if (!me) return; // Don't update if player data isn't available yet

        // Update scores and names
        playerNameEl.textContent = `Player ${me.playerNum}`;
        playerScoreEl.textContent = me.status.darkmatter > 0 ? '??' : me.score;
        playerStatusEl.textContent = getStatusText(me.status);

        if (opponent) {
            opponentNameEl.textContent = `Player ${opponent.playerNum}`;
            opponentScoreEl.textContent = opponent.status.darkmatter > 0 ? '??' : opponent.score;
            opponentStatusEl.textContent = getStatusText(opponent.status);
            // Apply dark matter blur effect
            playerScoreEl.classList.toggle('dark-matter-active', opponent.status.darkmatter > 0);
            opponentScoreEl.classList.toggle('dark-matter-active', me.status.darkmatter > 0);
        } else {
            opponentNameEl.textContent = 'Opponent';
            opponentScoreEl.textContent = '0';
            opponentStatusEl.textContent = '';
        }

        // Update deck
        deckCountEl.textContent = gameState.deck.length;

        // Update hand
        playerHandEl.innerHTML = '';
        const isMyTurn = activePlayer === myPlayerNum;
        deckEl.classList.toggle('disabled', !isMyTurn || me.hasDrawn);

        me.hand.forEach((card, index) => {
            const cardEl = document.createElement('div');
            cardEl.classList.add('card', card.type);
            // A card can be played if it's my turn and I haven't played an action card yet
            const canPlay = isMyTurn && !me.actionCardPlayedThisTurn;
            cardEl.classList.toggle('disabled', !canPlay);
            cardEl.innerHTML = `<div class="card-name">${card.name}</div><div class="card-type">${card.type.charAt(0).toUpperCase() + card.type.slice(1)}</div><div class="card-effect">${card.effect || ''}</div>`;
            if (canPlay) {
                cardEl.addEventListener('click', () => playActionCard(card, index));
            }
            playerHandEl.appendChild(cardEl);
        });

        // Update message area
        showMessage(message);

        // Update controls
        endTurnBtn.disabled = !isMyTurn || !me.hasDrawn || gameIsOver;
        if (gameIsOver) {
            gameControls.classList.remove('active');
            gameOverButtons.classList.add('active');
        } else {
            gameControls.classList.add('active');
            gameOverButtons.classList.remove('active');
        }
    }

    function getStatusText(status) {
        return Object.entries(status).map(([key, value]) => {
            const formattedKey = key.charAt(0).toUpperCase() + key.slice(1);
            return value === true ? formattedKey : `${formattedKey}: ${value}`;
        }).join(', ');
    }

    function showMessage(msg) {
        messageArea.textContent = msg;
    }

    // --- INITIALIZE ---
    showScreen('menu');
});
</script>
</body>
</html>